-- 1. tenant (Root)
CREATE TABLE TENANTS (
    TENANT_ID VARCHAR(20) NOT NULL,
    TENANT_NAME VARCHAR(100),
    TENANT_DESCRIPTION VARCHAR(255),
    USE_AT CHAR(1) DEFAULT 'Y',
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP,
    PRIMARY KEY (TENANT_ID)
);

CREATE TABLE BRANCHES (
    BRANCH_ID VARCHAR(20) NOT NULL,
    BRANCH_NAME VARCHAR(100) NOT NULL,
    BRANCH_CODE VARCHAR(20) UNIQUE NOT NULL,
    BRANCH_ADDRESS VARCHAR(255),
    BRANCH_PHONE VARCHAR(20),
    PARENT_BRANCH_ID VARCHAR(20),
    TENANT_ID VARCHAR(20) NOT NULL,
    USE_AT CHAR(1) DEFAULT 'Y',
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP,
    PRIMARY KEY (BRANCH_ID),
    FOREIGN KEY (TENANT_ID) REFERENCES TENANTS(TENANT_ID) ON DELETE CASCADE,
    FOREIGN KEY (PARENT_BRANCH_ID) REFERENCES BRANCHES(BRANCH_ID)
);
CREATE INDEX IDX_BRANCHES_TENANT ON BRANCHES(TENANT_ID);

CREATE TABLE GROUPS (
    GROUP_ID VARCHAR(20) NOT NULL,
    GROUP_NAME VARCHAR(100) NOT NULL,
    GROUP_CODE VARCHAR(20) NOT NULL,
    GROUP_DESCRIPTION VARCHAR(255),
    BRANCH_ID VARCHAR(20) NOT NULL,
    TENANT_ID VARCHAR(20) NOT NULL,
    USE_AT CHAR(1) DEFAULT 'Y',
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP,
    PRIMARY KEY (GROUP_ID),
    FOREIGN KEY (BRANCH_ID) REFERENCES BRANCHES(BRANCH_ID) ON DELETE CASCADE,
    FOREIGN KEY (TENANT_ID) REFERENCES TENANTS(TENANT_ID) ON DELETE CASCADE,
    UNIQUE (GROUP_CODE, TENANT_ID)
);
CREATE INDEX IDX_GROUPS_TENANT ON GROUPS(TENANT_ID);

CREATE TABLE POSITIONS (
    POSITION_ID VARCHAR(20) NOT NULL,
    POSITION_NAME VARCHAR(100) NOT NULL,
    POSITION_CODE VARCHAR(20) NOT NULL,
    POSITION_LEVEL INT DEFAULT 0,
    TENANT_ID VARCHAR(20) NOT NULL,
    USE_AT CHAR(1) DEFAULT 'Y',
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP,
    PRIMARY KEY (POSITION_ID),
    FOREIGN KEY (TENANT_ID) REFERENCES TENANTS(TENANT_ID) ON DELETE CASCADE,
    UNIQUE (POSITION_CODE, TENANT_ID)
);

CREATE TABLE MENUS (
    MENU_NO BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    MENU_CODE VARCHAR(50) UNIQUE NOT NULL,
    MENU_NAME VARCHAR(100) NOT NULL,
    MENU_TYPE VARCHAR(20) DEFAULT 'MENU', -- MENU, FOLDER, LINK
    MENU_PATH VARCHAR(255),
    API_ENDPOINT VARCHAR(255),
    ICON_NAME VARCHAR(50),
    UPPER_MENU_NO BIGINT,
    MENU_ORDER INT DEFAULT 0,
    IS_VISIBLE CHAR(1) DEFAULT 'Y',
    IS_ACTIVE CHAR(1) DEFAULT 'Y',
    TENANT_ID VARCHAR(20) NOT NULL,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATED_BY VARCHAR(20),
    FOREIGN KEY (TENANT_ID) REFERENCES TENANTS(TENANT_ID) ON DELETE CASCADE,
    FOREIGN KEY (UPPER_MENU_NO) REFERENCES MENUS(MENU_NO)
);

-- 6. permission (Auto-generated from MENUS)
CREATE TABLE PERMISSIONS (
    PERMISSION_ID BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    PERMISSION_CODE VARCHAR(100) NOT NULL,
    PERMISSION_TYPE VARCHAR(20) NOT NULL, -- 'API' or 'MENU'
    PERMISSION_ACTION VARCHAR(20) NOT NULL, -- 'READ', 'WRITE', 'DOWNLOAD'
    RESOURCE_PATH VARCHAR(255),
    MENU_NO BIGINT,
    TENANT_ID VARCHAR(20),
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (PERMISSION_ID),
    FOREIGN KEY (MENU_NO) REFERENCES MENUS(MENU_NO) ON DELETE CASCADE,
    UNIQUE (PERMISSION_CODE, PERMISSION_TYPE, PERMISSION_ACTION, TENANT_ID)
);

-- 7. role
CREATE TABLE ROLES (
    ROLE_ID VARCHAR(20) NOT NULL,
    ROLE_NAME VARCHAR(100) NOT NULL,
    ROLE_DESCRIPTION VARCHAR(255),
    TENANT_ID VARCHAR(20) NOT NULL,
    PRIMARY KEY (ROLE_ID),
    FOREIGN KEY (TENANT_ID) REFERENCES TENANTS(TENANT_ID) ON DELETE CASCADE
);

-- 8. user (consider eGovFrame)
CREATE TABLE USERS (
    ESNTL_ID VARCHAR(20) NOT NULL PRIMARY KEY, -- 고유 식별 ID
    USER_ID VARCHAR(20) UNIQUE NOT NULL,       -- 로그인 ID
    PASSWORD VARCHAR(255) NOT NULL,
    USER_NAME VARCHAR(100) NOT NULL,
    GROUP_ID VARCHAR(20),
    BRANCH_ID VARCHAR(20),
    POSITION_ID VARCHAR(20),
    MANAGER_ID VARCHAR(20),
    TENANT_ID VARCHAR(20) NOT NULL,
    USE_AT CHAR(1) DEFAULT 'Y',
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP,
    FOREIGN KEY (TENANT_ID) REFERENCES TENANTS(TENANT_ID) ON DELETE CASCADE,
    FOREIGN KEY (GROUP_ID) REFERENCES GROUPS(GROUP_ID),
    FOREIGN KEY (BRANCH_ID) REFERENCES BRANCHES(BRANCH_ID),
    FOREIGN KEY (POSITION_ID) REFERENCES POSITIONS(POSITION_ID),
    FOREIGN KEY (MANAGER_ID) REFERENCES USERS(ESNTL_ID)
);

-- 9. user-role releation (M:N)
CREATE TABLE USER_ROLES (
    USER_ROLE_ID BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    USER_ID VARCHAR(20) NOT NULL,
    ROLE_ID VARCHAR(20) NOT NULL,
    IS_PRIMARY CHAR(1) DEFAULT 'N',
    TENANT_ID VARCHAR(20) NOT NULL,
    FOREIGN KEY (USER_ID) REFERENCES USERS(ESNTL_ID) ON DELETE CASCADE,
    FOREIGN KEY (ROLE_ID) REFERENCES ROLES(ROLE_ID) ON DELETE CASCADE,
    FOREIGN KEY (TENANT_ID) REFERENCES TENANTS(TENANT_ID) ON DELETE CASCADE,
    UNIQUE (USER_ID, ROLE_ID, TENANT_ID)
);

-- 10. role-permission relation (M:N)
CREATE TABLE ROLE_PERMISSIONS (
    ROLE_PERMISSION_ID BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    ROLE_ID VARCHAR(20) NOT NULL,
    PERMISSION_ID BIGINT NOT NULL,
    TENANT_ID VARCHAR(20) NOT NULL,
    FOREIGN KEY (ROLE_ID) REFERENCES ROLES(ROLE_ID) ON DELETE CASCADE,
    FOREIGN KEY (PERMISSION_ID) REFERENCES PERMISSIONS(PERMISSION_ID) ON DELETE CASCADE,
    FOREIGN KEY (TENANT_ID) REFERENCES TENANTS(TENANT_ID) ON DELETE CASCADE,
    UNIQUE (ROLE_ID, PERMISSION_ID, TENANT_ID)
);